Validation of OSPC taxcalc Package
==================================

The taxcalc package calculates federal income taxes and FICA taxes for
a sample of tax filing units in years beginning with 2013.  The
Python code that performs the tax calculations has been validated in a
number of ways.  First, taxcalc results for a number of tax filing
units have been compared to hand calculations performed using IRS tax
forms.  Second, taxcalc results for a large sample of tax filing units
have been compared to results for the same sample generated by a
[detailed SAS program](http://www.nber.org/taxcalc) developed by Dan
Feenberg and Ina Shapiro of NBER.  And third, tools in this directory
provide the ability to conduct cross-model validation work using any
two tax models that read input formatted as expected by the [Internet
TAXSIM model](http://users.nber.org/~taxsim/taxsim-calc9/index.html)
and write output formatted as written by Internet TAXSIM with
intermediate results.  The ability to read and write tax information
in Internet-TAXSIM format is provided by the SimpleTaxIO class in the
OSPC taxcalc package and by simtax.py, which is a Python program that
provides a command-line interface to the SimpleTaxIO class.

The premise behind cross-model validation work is that independently
developed tax simulation models are unlikely to contain the
same bug, which means looking for differences between the output from
two models is an effective way to locate bugs in the tax calculation
logic.

The tools included in this directory support the following
validation work flow:

  1. Generate a random sample of tax filing units (INPUT).
  2. Generate OUTPUT from INPUT using simtax.py.
  3. Generate OUTPUT from INPUT using Internet TAXSIM.
  4. Generate tax-difference tabulations by comparing the two OUTPUT
     files.

Getting Started
===============

The current version of the validation tools in this directory should
work on Linux or Mac OS X without any changes.  Windows users will have
to do three things: (a) install an AWK interpreter, (b) install a Tcl 
interpreter, and (c) translate the `tests` bash script into a Windows
batch file.  The Free Software Foundation provides a free AWK interpreter
for Windows (gawk.exe) and ActiveState provides a free Tcl interpreter
for Windows (tclsh.exe).

Tool Usage
==========

Here is an overview of how the tools support the four-step work flow
described above.  All these tools provide additional help from the
command line.  The overview consists of examples of tool use and
assumes that the current working directory is taxcalc/validation/.

Generating an INPUT file
------------------------

(1) Generate a random sample of 100,000 tax filing units for 2014 that
have no itemized-deduction expenses and have no child-care expenses.

`tclsh make-in.tcl 2014 a > a2014.in`

(2) Generate a different random sample of 100,000 tax filing units for
2014 that have no itemized-deduction expenses and have no child-care
expenses.

`tclsh make-in.tcl 2014 a 1 > a2014-1.in`

When not using the optional third parameter, the
random-number-generator seed offset is set to zero.  In the example above,
the offset is one, which generates a sample in the `a2014-1.in` file
that is completely different from the sample in the `a2014.in` file.
The third parameter can have any value in the \[0,1000\] range, which
allows generation of as many as one thousand alternative samples.

(3) Generate a random sample of 100,000 tax filing units for 2013 that
have itemized-deduction expenses but no child-care expenses.

`tclsh make-in.tcl 2013 b > b2013.in`

(4) Generate a random sample of 100,000 tax filing units for 2013 that
have both itemized-deduction expenses and child-care expenses.

`tclsh make-in.tcl 2013 c > c2013.in`

Generating an OUTPUT file with simtax.py
----------------------------------------

(1) Generate OSPC-taxcalc-package OUTPUT (with no marginal tax rates
and assuming current-law policy) for the `c2013.in` INPUT file
described above in item (4).

`python ../../simtax.py c2013.in`

The resulting OUTPUT file is in the same directory as the INPUT file
and is called `c2013.in.out-simtax`.

(2) Do same thing as in item (1) except include marginal tax rates in
the OUTPUT.

`python ../../simtax.py --mtr c2013.in`

Generating an OUTPUT file with Internet TAXSIM
----------------------------------------------

(1) Generate Internet-TAXSIM OUTPUT for the `c2013.in` INPUT file
described above.

  * Browse [Internet TAXSIM
    model](http://users.nber.org/~taxsim/taxsim-calc9/index.html)
    home page.

  * Just under the heading *Upload a file with TAXSIM data*, do four
    things: (a) choose `c2013.in` as the file to upload, (b) click the
    On radio button to show detailed intermediate calculations, (c)
    enter `56 1` in the optional tax plan box to suppress property
    income smoothing in the calculation of the EITC, and (d) click
    on the button labeled "calculate using this file's data".

  * After a few seconds a new browser page is opened automatically
    and the Internet TAXSIM output results start to fill up that page.

  * After results for all 100,000 tax filing units have been written
    to that browser page, save them to a file called, in this example,
    `c2013.in.out-taxsim`.  Do this as follows: (a) in the new browser
    page, "Select All" and then "Copy" to put the contents of the new
    browser page into the computer's clipboard, and (b) use a text
    editor to "Paste" the contents of the clipboard into an editor
    buffer, but before saving the buffer to a file be sure to remove
    any blank lines and the TAXSIM message about using the `56 1`
    option (which is usually at the top of the results).

Generating tax-difference tabulations
-------------------------------------

(1) Continuing the above example that uses `c2013.in` INPUT and
produces no marginal tax rates, generate a summary of differences in
intermediate and final tax OUTPUT variables and write that summary to
a file called `c2013.taxdiffs`.

`tclsh taxdiffs.tcl c2013.in.out-simtax c2013.in.out-taxsim > c2013.taxdiffs`


Automating the validation process
----------------------------------

(1) Currently six samples, each containing 100,000 randomly-generated
tax filing units, have been used to generate Internet-TAXSIM OUTPUT
files that are stored in the out-taxsim.zip file.  The `tests` bash
script automates the four-step validation process described above.
The `tests` script takes longer to execute (roughly seven or eight
minutes) than the tests in the taxcalc/tests directory (roughly one
minute).  But if the content of the six ?1?.taxdiffs files that are
under version control are not modified by a `tests` execution, this a
more thorough confirmation that taxcalc logic has not changed.
