Validation of Tax-Calculator
============================

The Tax-Calculator computes federal income taxes and FICA taxes for
a sample of tax filing units in years beginning with 2013.  The
Python code that performs the tax calculations has been validated in a
number of ways.  First, Tax-Calculator results for a number of tax filing
units have been compared to hand calculations performed using IRS tax
forms.  Second, Tax-Calculator results for a large sample of tax filing
units have been compared to results for the same sample generated by a
[detailed SAS program](http://www.nber.org/taxcalc) developed by Dan
Feenberg and Ina Shapiro of NBER.  And third, tools in this directory
provide the ability to conduct cross-model validation work using any
two tax models that read input formatted as expected by the [Internet
TAXSIM model](http://users.nber.org/~taxsim/taxsim-calc9/index.html)
and write output formatted as written by the Internet TAXSIM model.
The ability to read and write tax information in Internet-TAXSIM format
is provided by the Tax-Calculator SimpleTaxIO class and by simtax.py,
which is a Python program that provides a command-line interface to the
SimpleTaxIO class.

The premise behind cross-model validation work is that independently
developed tax simulation models are unlikely to contain the
same bug, which means looking for differences between the output from
two models is an effective way to locate bugs in the tax calculation
logic.

The tools included in this directory support the following
validation work flow:

  1. Generate a random sample of tax filing units (INPUT).
  2. Generate OUTPUT from INPUT using simtax.py.
  3. Generate OUTPUT from INPUT using Internet TAXSIM.
  4. Generate tax differences by comparing the two OUTPUT files.

Installing Validation Tools
===========================

The current version of the validation tools in this directory should
work on Linux or Mac OS X without any changes and without adding any
extra software.  Those who want to use these validation tools on Windows
will have to do three things: (a) install an AWK interpreter,
(b) install a Tcl interpreter, and (c) translate the `tests` bash script
into a Windows batch file (tests.bat).  The Free Software Foundation
provides a free AWK interpreter for Windows (gawk.exe) and ActiveState
provides a free Tcl interpreter for Windows (tclsh.exe).

Using Validation Tools
======================

Here is an overview of how the tools support the four-step work flow
described above.  The validation tools provide additional help from
the command line.  This overview consists of examples of tool use and
assumes that the current working directory is taxcalc/validation/.

Generating an INPUT file
------------------------

(1) Generate a random sample of 100,000 tax filing units for 2014 that
have no itemized-deduction expenses and have no child-care expenses.

`tclsh make-in.tcl 2014 a > a2014.in`

(2) Generate a different random sample of 100,000 tax filing units for
2014 that have no itemized-deduction expenses and have no child-care
expenses.

`tclsh make-in.tcl 2014 a 1 > a2014-1.in`

When not using the optional third parameter, the
random-number-generator seed offset is set to zero.  In the example above,
the offset is one, which generates a sample in the `a2014-1.in` file
that is completely different from the sample in the `a2014.in` file.
The third parameter can have any value in the \[0,1000\] range, which
allows generation of as many as one thousand alternative samples.

(3) Generate a random sample of 100,000 tax filing units for 2013 that
have itemized-deduction expenses but no child-care expenses.

`tclsh make-in.tcl 2013 b > b2013.in`

(4) Generate a random sample of 100,000 tax filing units for 2013 that
have both itemized-deduction expenses and child-care expenses.

`tclsh make-in.tcl 2013 c > c2013.in`

(5) The Tax-Calculator versus Internet-TAXSIM validation tests
use six samples of 100,000 tax filing units generated by the
make-in.tcl program.  There are a, b, and c samples (see make-in.tcl
for details) for 2013 and for 2014.  All together, these samples
contain 600,000 randomly-generated tax filing units.

Generating an OUTPUT file with simtax.py
----------------------------------------

(1) Generate Tax-Calculator OUTPUT (assuming current-law policy)
for the `c2013.in` INPUT file described above in item (4).

`python ../../simtax.py c2013.in`

The resulting OUTPUT file is in the same directory as the INPUT file
and is called `c2013.in.out-simtax`.

(2) Do same thing as in item (1) except suppress calculation of the
two marginal tax rates and write zero for each marginal tax rate in
the OUTPUT.

`python ../../simtax.py --nomtr c2013.in`

(3) Do same thing as in item (1) except emulate Internet TAXSIM logic
regarding the approximation of Form 2441 qualified persons for whom
child-care expenses are incurred.

`python ../../simtax.py --taxsim2441 c2013.in`

The above command produces an OUTPUT file that can be compared with
OUTPUT generated by Internet TAXSIM.  The TAXSIM approximation assumes
the number of Form 2441 qualified persons is equal to the total number
of dependents of all ages, while the default simtax.py approximation
uses the number of dependents under age 17.

(4) Generate extra OUTPUT variables that are useful in debugging
Tax-Calculator logic.

`Temporarily edit the DVAR_NAMES list in the simpletaxio.py file.`

Generating an OUTPUT file with Internet TAXSIM
----------------------------------------------

(1) Generate Internet-TAXSIM OUTPUT for the `c2013.in` INPUT file
described above.

  * Browse [Internet TAXSIM
    model](http://users.nber.org/~taxsim/taxsim-calc9/index.html)
    home page.

  * Just under the heading *Upload a file with TAXSIM data*, do four
    things: (a) choose `c2013.in` as the file to upload, (b) click the
    On radio button to show detailed intermediate calculations, (c)
    enter `56 1` in the optional tax plan box to suppress property
    income smoothing in the calculation of the EITC, and (d) click
    on the button labeled "calculate using this file's data".

  * After a few seconds a new browser page is opened automatically
    and the Internet TAXSIM output results start to fill up that page.

  * After results for all 100,000 tax filing units have been written
    to that browser page, save them to a file called, in this example,
    `c2013.in.out-taxsim`.  Do this as follows: (a) in the new browser
    page, "Select All" and then "Copy" to put the contents of the new
    browser page into the computer's clipboard, and (b) use a text
    editor to "Paste" the contents of the clipboard into an editor
    buffer, but before saving the buffer to a file be sure to remove
    any blank lines and the TAXSIM message about using the `56 1`
    option (which is usually at the top of the results).

Generating tax-difference results
---------------------------------

(1) Continuing the above example that uses `c2013.in` INPUT, generate
a summary of differences in intermediate and final tax OUTPUT
variables and write those summary results to a file called
`c2013.taxdiffs`.

`tclsh taxdiffs.tcl c2013.in.out-simtax c2013.in.out-taxsim > c2013.taxdiffs`

Reading tax-difference results
------------------------------

The tax-difference tools work with the same philosophy as the Unix
diff command: no results are shown unless these are differences
between the two OUTPUT files being compared.  But instead of showing
all the tax filing units whose OUTPUT differs, the tax-difference
tools show a summary of the differences.  The summary information for
a particular OUTPUT variable includes:

  * *ovar*: the number of the OUTPUT variable whose differences are
                being summarized,
  * *#diffs*: the number of filing units that have a difference in the
                value of this OUTPUT variable between the two OUTPUT
                files being compared,
  * *#1cdiffs*: the number of filing units for which the absolute
                value of this difference is no more than one cent,
  * *maxdiff*: the signed value of the absolute value of the largest
                difference, and
  * *[id]*: the id (ivar[1] and ovar[1]) of the filing unit with the
                largest difference in absolute value.  In other words,
                the filing unit with the given *id* is the filing unit
                with the *maxdiff*.

When appropriate, a second line of summary results is shown.  This
second line contains the number of filing units with an OUTPUT
variable difference greater than one cent (that is, is not included in
*#1cdiffs* on the main summary line) **and** a total tax liability
(ovar[4]) that is greater than one cent in absolute value.  If there
are no filing units that meet both criteria, the second line is not
written.

Automating Validation Process
=============================

Currently six samples, each containing 100,000 randomly-generated tax
filing units, have been used to generate Internet TAXSIM OUTPUT files
that are stored in the out-taxsim.zip file.  The `tests` bash script
automates the four-step validation process described above.  The
`tests` script takes longer to execute (roughly nine or ten minutes)
than the unit tests in the taxcalc/tests directory (roughly one or two
minutes).  But if the content of the six ?1?.taxdiffs files that are
under version control are not modified by a `tests` execution, this a
more thorough confirmation that Tax-Calculator logic has not changed.

Current Validation Results
==========================

Since early November, 2015, there have been no FICA tax liability
and no federal income tax liability differences (of more than one cent
in absolute value) between Tax-Calculator results and Internet-TAXSIM
results for the 600,000 randomly-generated tax filing units
described above.  There are some (more than one cent) differences in
intermediate results and these are being investigated.
