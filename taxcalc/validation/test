#!/bin/bash
# Execute validation TEST using Tax-Calculator SimpleTaxIO class as follows:
# (1) generates a random sample of tax filing units (INPUT),
# (2) generates OUTPUT from INPUT and REFORM using simtax.py, and
# (3) generate tax-difference tabulations by comparing OUTPUT with output
#     file generated by Internet-TAXSIM using the same INPUT and REFORM.
# Check command-line arguments
if [[ "$#" -ne 2 ]]; then
    echo "ERROR: not exactly two command-line arguments"
    echo "USAGE: ./test LYY REFORM"
    echo "       where L is letter in [a,b,c] and YY is number in [13,14]"
    echo "       and where REFORM is Internet-TAXSIM option (e.g., '50_1') or"
    echo "       '.' for no reform (i.e., current-law policy)"
    exit 1
fi
LYY=$1
REFORM=$2
# Generate specified INPUT file
L=${LYY:0:1}    
YY=${LYY:1:2}
tclsh make-in.tcl 20$YY $L > $LYY.in
# Generate simtax.py OUTPUT for specified INPUT and REFORM
if [[ "$REFORM" == "." ]] ; then
    python ../../simtax.py --taxsim2441 $LYY.in
    SUFFIX=""
    OVAR4=""
else
    RJSON="reform-$REFORM.json"
    python ../../simtax.py --taxsim2441 --reform $RJSON $LYY.in
    SUFFIX="-reform-$REFORM"
    OVAR4="--ovar4"
fi
# Unzip Internet-TAXSIM output for specified INPUT and REFORM
unzip -oq out-taxsim.zip $LYY.in.out-taxsim$SUFFIX
# Compare simtax and Internet-TAXSIM OUTPUT
tclsh taxdiffs.tcl $OVAR4 $LYY.in.out-simtax$SUFFIX \
                          $LYY.in.out-taxsim$SUFFIX > $LYY$SUFFIX.taxdiffs
git diff --name-status $LYY$SUFFIX.taxdiffs
rm $LYY.in $LYY.in.out-simtax$SUFFIX $LYY.in.out-taxsim$SUFFIX
exit 0
